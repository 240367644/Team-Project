<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basket - Accom4U</title>

    
</head>

<body>

<header>
    <h1>Accom4U - Your Basket</h1>
    <a id="loginLink" class="login" href="login.html"><b>Log In</b></a>
</header>

<main class="basket-container">

    <div class="basket-items"></div>

    <div class="basket-summary">
        <h3>Order Summary</h3>

        <div class="summary-line">
            <span>Subtotal</span>
            <span id="subtotal">£0.00</span>
        </div>

        <div class="summary-line">
            <span>Delivery</span>
            <span>£0.00</span>
        </div>

        <div class="summary-total">
            <span>Total</span>
            <span id="total">£0.00</span>
        </div>

        <a href="checkout.html" class="checkout-btn">Proceed to Checkout</a>
    </div>

</main>

<footer>
    © 2025 Accom4U
</footer>

<script>
let basket = []; // will be loaded from backend

/* -------------------------
   Load basket from PHP backend
---------------------------*/
function loadBasket() {
    fetch('basket.php?path=getBasket')
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                basket = Object.values(data.basket); // convert cart object to array
                displayBasket(data.summary);
            } else {
                console.log("Error loading basket:", data.message);
            }
        })
        .catch(err => console.log("Fetch error:", err));
}

/* -------------------------
   Display Basket Contents
---------------------------*/
function displayBasket(summary = null) {
    const container = document.querySelector(".basket-items");
    container.innerHTML = "";

    let subtotal = 0;

    basket.forEach((item, index) => {
        subtotal += item.price * item.quantity;

        container.innerHTML += `
            <div class="basket-item">
                <img src="${item.image || 'images/sample-product.jpg'}" alt="product">

                <div class="item-details">
                    <h3>${item.name}</h3>
                    <p>£${item.price.toFixed(2)}</p>

                    <div class="quantity-control">
                        <button onclick="changeQty(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="changeQty(${index}, 1)">+</button>
                    </div>

                    <button class="remove-item" onclick="removeItem(${index})">Remove</button>
                </div>
            </div>
        `;
    });

    if (summary) {
        document.getElementById("subtotal").textContent = "£" + summary.subtotal.toFixed(2);
        document.getElementById("total").textContent = "£" + summary.total.toFixed(2);
    } else {
        document.getElementById("subtotal").textContent = "£" + subtotal.toFixed(2);
        document.getElementById("total").textContent = "£" + subtotal.toFixed(2);
    }
}

/* -------------------------
   Change Quantity
---------------------------*/
function changeQty(index, amount) {
    const item = basket[index];
    const newQty = item.quantity + amount;

    if (newQty <= 0) {
        removeItem(index);
        return;
    }

    fetch('basket.php?path=updateQuantity', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: `product_id=${item.id}&quantity=${newQty}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") loadBasket();
    });
}

/* -------------------------
   Remove Item
---------------------------*/
function removeItem(index) {
    const item = basket[index];
    fetch('basket.php?path=removeItem', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: `product_id=${item.id}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") loadBasket();
    });
}

/* -------------------------
   Initial load
---------------------------*/
document.addEventListener('DOMContentLoaded', () => {
    loadBasket();

    // Dynamic login/logout link based on session
    fetch('session.php', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
            const loginLink = document.getElementById('loginLink');
            if (data.loggedIn) {
                loginLink.href = 'logout.php';
                loginLink.innerHTML = '<b>Logout</b>';
            }
        })
        .catch(err => console.error('Error checking session:', err));
});
</script>

</body>
</html>
